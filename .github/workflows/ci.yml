name: CI

on: [push, pull_request]

jobs:

  test-ubuntu-latest:
    runs-on: ubuntu-latest
    name: Building memKeydB allocator ${{ matrix.allocator }} | ${{ matrix.env.cc }}}
    strategy:
      matrix:
        env:
          - { cc: gcc, cxx: g++}
          - { cc: clang, cxx: clang++}
        allocator: [jemalloc, memkind]
    steps:

    - name: Checkout repository and submodules
      uses: actions/checkout@v2
      with:
        submodules: recursive

    - name: Install basic dependencies
      run: sudo apt install libjson-c-dev libkeyutils-dev libkmod-dev libnuma-dev libudev-dev tcl8.5 uuid-dev

    - name: Install ndctl
      run: |
          wget https://github.com/pmem/ndctl/archive/v68.tar.gz
          tar -xzvf v68.tar.gz
          pushd ndctl-68 && ./autogen.sh && ./configure --disable-docs --prefix=/usr && make && sudo make install && popd

    - name: Build memKeydB
      run: make gcov MALLOC=${{ matrix.allocator }}

    - name: Run Tests
      run: |
          if [ "${{ matrix.allocator }}" == memkind ]; then
            MEMKIND_DAX_KMEM_NODES=0 ./runtest --pmem-ratio --clients 1
          fi
          ./runtest --clients 1

    - name: Upload to Codecov
      run: bash <(curl -s https://codecov.io/bash) -p src
